# Azure DevOps YAML Template: SONiC Dependencies Installation
#
# This template contains all the common dependency installation steps shared between
# jobs that require CGO/SONiC dependencies (MemoryLeakJob and IntegrationCIJob).
#
# Usage in pipeline jobs:
#   - template: .azure/templates/install-dependencies.yml
#     parameters:
#       buildBranch: $(BUILD_BRANCH)
#
# Dependencies installed:
#   - libyang (from sonic-buildimage artifacts)
#   - libnl packages (from sonic-buildimage artifacts)
#   - sonic-swss-common libraries
#   - protobuf compiler
#
# Note: Building sonic-mgmt-common and sonic-gnmi is NOT included here.
# Only the IntegrationCIJob needs to build and publish artifacts, so that
# step is defined directly in azure-pipelines.yml to avoid duplicate builds.
#
# This eliminates code duplication and ensures consistent dependency setup
# across all jobs that need SONiC/CGO dependencies.

parameters:
- name: buildBranch
  type: string
  default: $(BUILD_BRANCH)

steps:
# Download basic dependencies from sonic-buildimage
- task: DownloadPipelineArtifact@2
  inputs:
    source: specific
    project: build
    pipeline: 142
    artifact: sonic-buildimage.vs
    runVersion: 'latestFromBranch'
    runBranch: 'refs/heads/${{ parameters.buildBranch }}'
    patterns: |
        target/debs/bookworm/libyang*.deb
        target/debs/bookworm/libnl*.deb
        target/python-wheels/bookworm/sonic_yang_models*.whl
  displayName: "Download bookworm debs"

# Install pytest, jsonpatch, redis and libyang
- script: |
    # PYTEST
    sudo pip3 install -U pytest
    sudo pip3 install -U jsonpatch

    # REDIS
    sudo apt-get update
    sudo apt-get install -y redis-server
    sudo sed -ri 's/^# unixsocket/unixsocket/' /etc/redis/redis.conf
    sudo sed -ri 's/^unixsocketperm .../unixsocketperm 777/' /etc/redis/redis.conf
    sudo sed -ri 's/redis-server.sock/redis.sock/' /etc/redis/redis.conf
    sudo service redis-server start

    # LIBYANG
    # Note: Must use version-specific pattern to avoid conflicts with libyang3 packages
    sudo dpkg -i ../target/debs/bookworm/libyang*1.0.73*.deb
  displayName: "Install dependency"

# Install sonic yangs
- script: |
    # SONIC YANGS
    set -ex
    sudo pip3 install ../target/python-wheels/bookworm/sonic_yang_models*.whl
  displayName: "Install sonic yangs"

# Install libswsscommon dependencies
- script: |
    # LIBSWSSCOMMON dependencies
    sudo apt-get -y purge libnl-3-dev libnl-route-3-dev
    sudo dpkg -i ../target/debs/bookworm/libnl-3-200_*.deb
    sudo dpkg -i ../target/debs/bookworm/libnl-genl-3-200_*.deb
    sudo dpkg -i ../target/debs/bookworm/libnl-route-3-200_*.deb
    sudo dpkg -i ../target/debs/bookworm/libnl-nf-3-200_*.deb
  displayName: "Install libswsscommon dependencies"

# Install .NET Core
- script: |
    set -ex
    # Install .NET CORE
    curl -sSL https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
    sudo apt-add-repository https://packages.microsoft.com/debian/12/prod
    sudo apt-get update
    sudo apt-get install -y dotnet-sdk-8.0
  displayName: "Install .NET CORE"

# Download sonic-swss-common
- task: DownloadPipelineArtifact@2
  inputs:
    source: specific
    project: build
    pipeline: Azure.sonic-swss-common
    artifact: sonic-swss-common-bookworm
    runVersion: 'latestFromBranch'
    runBranch: 'refs/heads/${{ parameters.buildBranch }}'
  displayName: "Download sonic-swss-common"

# Install libswsscommon packages
- script: |
    set -ex
    # LIBSWSSCOMMON
    sudo dpkg -i libswsscommon_1.0.0_amd64.deb
    sudo dpkg -i libswsscommon-dev_1.0.0_amd64.deb
    sudo dpkg -i python3-swsscommon_1.0.0_amd64.deb
  workingDirectory: $(Pipeline.Workspace)/
  displayName: 'Install libswsscommon package'

# Install protoc
- script: |
    sudo apt-get install -y protobuf-compiler
    protoc --version
  displayName: 'Install protoc'
