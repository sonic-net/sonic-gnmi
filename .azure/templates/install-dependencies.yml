# Azure DevOps YAML Template: SONiC Dependencies Installation
#
# This template contains all the common dependency installation steps shared between
# jobs that require CGO/SONiC dependencies (MemoryLeakJob and IntegrationCIJob).
#
# Usage in pipeline jobs:
#   - template: .azure/templates/install-dependencies.yml
#     parameters:
#       buildBranch: $(BUILD_BRANCH)
#
# Dependencies installed:
#   - libyang (from sonic-buildimage artifacts)
#   - libnl packages (from sonic-buildimage artifacts)
#   - sonic-swss-common libraries
#   - protobuf compiler
#   - Builds sonic-mgmt-common and sonic-gnmi with dpkg-buildpackage
#
# This eliminates code duplication and ensures consistent dependency setup
# across all jobs that need SONiC/CGO dependencies.

parameters:
- name: buildBranch
  type: string
  default: $(BUILD_BRANCH)

steps:
# Download basic dependencies from sonic-buildimage
- task: DownloadPipelineArtifact@2
  inputs:
    source: specific
    project: build
    pipeline: 142
    artifact: sonic-buildimage.vs
    runVersion: 'latestFromBranch'
    runBranch: 'refs/heads/${{ parameters.buildBranch }}'
    patterns: |
        target/debs/bookworm/libyang*.deb
        target/debs/bookworm/libnl*.deb
        target/python-wheels/bookworm/sonic_yang_models*.whl
  displayName: "Download bookworm debs"

# Install libyang
- script: |
    # LIBYANG
    sudo dpkg -i ../target/debs/bookworm/libyang*1.0.73*.deb
  displayName: "Install libyang"

# Install libswsscommon dependencies
- script: |
    # LIBSWSSCOMMON dependencies
    sudo apt-get -y purge libnl-3-dev libnl-route-3-dev
    sudo dpkg -i ../target/debs/bookworm/libnl-3-200_*.deb
    sudo dpkg -i ../target/debs/bookworm/libnl-genl-3-200_*.deb
    sudo dpkg -i ../target/debs/bookworm/libnl-route-3-200_*.deb
    sudo dpkg -i ../target/debs/bookworm/libnl-nf-3-200_*.deb
  displayName: "Install libswsscommon dependencies"

# Download sonic-swss-common
- task: DownloadPipelineArtifact@2
  inputs:
    source: specific
    project: build
    pipeline: Azure.sonic-swss-common
    artifact: sonic-swss-common-bookworm
    runVersion: 'latestFromBranch'
    runBranch: 'refs/heads/${{ parameters.buildBranch }}'
  displayName: "Download sonic-swss-common"

# Install libswsscommon packages
- script: |
    set -ex
    # LIBSWSSCOMMON
    sudo dpkg -i libswsscommon_1.0.0_amd64.deb
    sudo dpkg -i libswsscommon-dev_1.0.0_amd64.deb
    sudo dpkg -i python3-swsscommon_1.0.0_amd64.deb
  workingDirectory: $(Pipeline.Workspace)/
  displayName: 'Install libswsscommon package'

# Install protoc
- script: |
    sudo apt-get install -y protobuf-compiler
    protoc --version
  displayName: 'Install protoc'

# Build dependencies (sonic-mgmt-common and sonic-gnmi)
- script: |
    set -ex
    pushd sonic-mgmt-common
    NO_TEST_BINS=1 dpkg-buildpackage -rfakeroot -b -us -uc
    popd
    pushd sonic-gnmi
    ENABLE_TRANSLIB_WRITE=y dpkg-buildpackage -rfakeroot -us -uc -b -j$(nproc)
  displayName: "Build dependencies"